<!DOCTYPE HTML>
<HTML>
  <HEAD>
    <TITLE>caveman.3</TITLE>
    <META CHARSET='UTF-8'>
    <META NAME='auhtor' CONTENT='hyotang666'>
    <META NAME='generator' CONTENT='pages'>
    <LINK REL='stylesheet' HREF='../css/css.css' TYPE='text/css'>
  </HEAD>
  <BODY>
    <MAIN>
      <!-- {% raw %} -->

<h1>Caveman kills ruby on rails - Chapter 3</h1>

<h2>Meta info</h2>

<h3>対象読者</h3>

<ul>
<li><a href="http://8arrow.org/caveman/" >Caveman</a>とそのテンプレートエンジンである<a href="https://mmontone.github.io/djula/" >djula</a>に興味のあるCLer</li>
</ul>

<h2>Introduction</h2>

<p>本稿は<a href="https://book.impress.co.jp/books/1117101135" >原著</a>の各章をCommon Lispに翻訳するシリーズの第3章である。
本章ではCavemanの基礎とDjulaの基礎を修めていく。</p>

<h2>ルーティングの追加</h2>

<p>web.lispに以下の宣言を追加しよう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/about"</span><span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">render #P<span class="string">"about.html"</span> '<span class="paren3">(<span class="code"><span class="keyword">:page-title</span> <span class="string">"About"</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>templatesディレクトリ下にabout.htmlファイルを作る。
中身は以下である。</p>

<pre><code>&lt;p&gt;This is demo of caveman.&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-about.png" alt="Screen shot of example" /></p>

<h2>CAVEMAN2.ROUTE:DEFROUTEの詳細</h2>

<p>bnfはだいたい以下の通り。</p>

<p>ここで「だいたい」と言っているのは、これが公式のドキュメントではなく僕がソースコードをなめまわして書いたものだからだ。
僕個人はあらゆるマクロはbnfを持つべきと思っているので、公式にbnfがないのは遺憾である。
Common Lispのマクロが分かりにくいと不評を買うのは、マクロという形で新しい言語が作られているのに、その言語のbnfがないからだと思っている。
bnfすら存在しないプログラミング言語を習いたいかと自問自答すれば、僕の答えはNOである。</p>

<pre><code>(defroute name? routing-rule routing-lambda-list body*)

name := symbol ; not evaluated.

routing-rule := [ rule-string | full-rule ]
rule-string := string
full-rule := (rule-generate-form &key method identifier regexp &allow-other-keys)
rule-generate-form := form ; which generate rule-string, evaluated.
method := [ :get | :post | :put | :delete | :options ]
identifier := internal-use ; ignorable.
regexp := boolean ; you need specify T when rule string has regexp.

routing-lambda-list := list

body := form\*</code></pre>

<h3>name</h3>

<p>これは通常無視できる。
すなわち指定しなくともよい。
指定するとそのシンボルに一引数関数が定義され、デバッグが少し楽になる。</p>

<p>定義された関数が受け取る引数は、routing-lambda-listへと渡す引数をまとめたものである。</p>

<h3>rule-string</h3>

<p>もっとも単純なものは、ただのパスである。
(e.g. &ldquo;/&rdquo;)</p>

<p>キーワードを含むと<code>&amp;KEY</code>で受けられるようになる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello/:name"</span> <span class="comment">; &lt;--- Specified keyword
</span>          <span class="paren2">(<span class="code">&amp;key name</span>)</span>    <span class="comment">; &lt;--- is passed as parameter.
</span>  <span class="paren2">(<span class="code">format nil <span class="string">"Hello, ~A"</span> name</span>)</span></span>)</span></span></code></pre>

<p>wildcardを含むと<code>&amp;KEY SPLAT</code>で受けられるようになる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/say/*/to/*"</span> <span class="paren2">(<span class="code">&amp;key splat</span>)</span>
  <span class="comment">; matches /say/hello/to/world
</span>  <span class="paren2">(<span class="code">format nil <span class="string">"~A"</span> splat</span>)</span></span>)</span>
<span class="comment">;=&gt; (hello world)
</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/download/*.*"</span> <span class="paren2">(<span class="code">&amp;key splat</span>)</span>
  <span class="comment">; matches /download/path/to/file.xml
</span>  <span class="paren2">(<span class="code">format nil <span class="string">"~A"</span> splat</span>)</span></span>)</span> 
<span class="comment">;=&gt; (path/to/file xml)</span></span></code></pre>

<p>キーワード引数で:REGEXPを指定すれば正規表現も使える。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="paren2">(<span class="code"><span class="string">"/hello/([</span><span class="string">\\</span><span class="string">w]+)"</span> <span class="keyword">:regexp</span> t</span>)</span> <span class="paren2">(<span class="code">&amp;key captures</span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"Hello, ~A!"</span> <span class="paren3">(<span class="code">first captures</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>&apos;?&apos;でキーワードを囲めば２種類のパスを同時に作れる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello/?:name?"</span><span class="paren2">(<span class="code">&amp;key name</span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"Hello ,~A"</span> name</span>)</span></span>)</span></span></code></pre>

<p>上記のルーティングには&ldquo;/hello/hoge&rdquo;でも&ldquo;/hello?NAME=hoge&rdquo;でもアクセスできる。
クエリ文字列のキーを大文字で指定しなければならない点要注意。
&ldquo;/hello?name=hoge&rdquo;にアクセスすると変数<code>name</code>はNILに束縛されることとなる。</p>

<p>クエリ文字列のキーを小文字での指定にしたい場合は、&amp;KEYで受ける変数を縦棒で囲めば対応できる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello/?:name?"</span><span class="paren2">(<span class="code">&amp;key |name|</span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"Hello ,~A"</span> |name|</span>)</span></span>)</span></span></code></pre>

<p>しかしそうすると&ldquo;/hello/hoge&rdquo;という形でアクセスした場合、変数|name|がNILに束縛されてしまう。</p>

<p>この&apos;?&apos;で囲む記法がcavemanのREADMEに載っていないのは、作者自身が使ってもらいたくないと思っているからなのかもしれない。</p>

<h3>routing-lambda-list</h3>

<p>通常のラムダリスト(ordinary-lambda-list)に見えて、その実、異なるものなので、ここではあえてrouting-lambda-listと名付けている。
このラムダリストはURIに含まれるクエリパラメタやキーワードで指定したパス変数などをキーワード引数として受け付ける用のものである。
ここで重要な点が3つある。</p>

<p>1つめはrouting-ruleで指定したキーワード、ないし<code>&amp;KEY</code>で指定したクエリパラメタのみが引数として渡されてくるという点である。
たとえば以下のようなroutingがあったとしよう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello"</span><span class="paren2">(<span class="code">&amp;rest args</span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"~S"</span> args</span>)</span></span>)</span></span></code></pre>

<p>&ldquo;/hello?a=1&amp;b=2&rdquo;にアクセスされたとき<code>ARGS</code>には何が入るだろうか？
答えはNIL、すなわち引数はない。
<code>&amp;KEY</code>による指定がないからである。</p>

<p>2つめは（前節の繰り返しになるが）クエリパラメタを<code>&amp;KEY</code>で指定するばあい、その<code>SYMBOL-NAME</code>がキーとなる点だ。
たとえば以下のようなroutingがあったとしよう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello"</span><span class="paren2">(<span class="code">&amp;key name</span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"~S"</span>name</span>)</span></span>)</span></span></code></pre>

<p>この場合URIに含まれるクエリ変数キーは通常大文字でなければならない。
（すなわち&ldquo;/hello?NAME=anonymous&rdquo;）
「通常」としたのは、これが<code>CL:READTABLE-CASE</code>に依存しており、その値は設定可能だからだ。
多くの処理系は<code>:UPCASE</code>を規定値としているので、設定していないのなら通常、<code>CL:SYMBOL-NAME</code>は大文字となる。</p>

<p><code>CL:READTABLE-CASE</code>の影響を受けたくないのであれば、縦棒でシンボルを包むのが良い。
縦棒で包まれたシンボルは<code>CL:READTABLE-CASE</code>の値によらず、ケースが保持されるからだ。
変数名がたとえば<code>|name|</code>とされた場合、たとえ<code>CL:READTABLE-CASE</code>が<code>:UPCASE</code>であっても、<code>NAME</code>と大文字に畳み込まれることなく<code>|name|</code>となりケースが保持される。</p>

<p>この点READMEに解説がなく、天下りな指示になっているのは不親切だと思う。</p>

<p>さて3つめの注意点だが、<code>&amp;KEY</code>で渡す変数のシンタックスが通常のシンタックスとは異なる点である。
Common Lispのキーワード引数は（マニアックな機能ではあるが）公開キーと内部変数とを別のものにすることが可能である。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren3">(<span class="code">&amp;key<span class="paren4">(<span class="code"><span class="paren5">(<span class="code"><span class="keyword">:external</span> internal</span>)</span> <span class="keyword">:initial-value</span></span>)</span></span>)</span>
    internal</span>)</span>
  <span class="keyword">:external</span> 3</span>)</span>
<span class="comment">; =&gt; 3</span></span></code></pre>

<p>これは主にスペシャル変数の初期値をキーワード引数で受け取りたい場合便利である。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren3">(<span class="code">&amp;key<span class="paren4">(<span class="code"><span class="paren5">(<span class="code"><span class="keyword">:stream</span> <span class="special">*standard-output*</span></span>)</span><span class="special">*standard-output*</span></span>)</span></span>)</span>
    ...</span>)</span>
 <span class="keyword">:stream</span> <span class="special">*debug-io*</span></span>)</span></span></code></pre>

<p>この記法がなければ<code>LET</code>で明示的に束縛し直さなければならなくなる。</p>

<p>CAVEMAN2.ROUTE:DEFROUTEでこの記法はサポートされていない。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/hello"</span> <span class="paren2">(<span class="code">&amp;key <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="keyword">:|name|</span> name</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">format nil <span class="string">"Hello ,~A"</span> name</span>)</span></span>)</span></span></code></pre>

<p>いちいち縦棒で変数名をくくるのは面倒なので、上記のように書けたら嬉しいと思ったのだが、そんなことはできない。</p>

<p>READMEに説明がないのは不親切だと思う。</p>

<h3>body</h3>

<p>返り値は以下のいずれかである。</p>

<h4>string</h4>

<p>文字列がかえされた場合、それがContent-Type: text/htmlのボディとしてクライアントに送られる。</p>

<h4>pathname</h4>

<p>パスネームが返された場合、そのファイルの中身がContent-Type: text/htmlのボディとしてクライアントに送られる。</p>

<h4>list</h4>

<p>リストが返された場合、以下のフォーマットになっていなければならない。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">status-code http-headers &amp;optional body</span>)</span></span></code></pre>

<h5>status-code</h5>

<p>整数で指定する。</p>

<h5>http-headers</h5>

<p>READMEに出てくる<code>(:content-type &quot;text/plain&quot;)</code>以外の情報が皆無である。
httpレスポンスのヘッダを指定するものらしいのは分かるのだが、それしかわからない。
色々調べた結果、以下のことが判明した。</p>

<ul>
<li>キーバリューのPLIST形式で指定する。</li>
<li>キーはキーワードシンボルか文字列で指定する。</li>
<li>通常のシンボルも使用可能だが、その場合既定値が存在するとヘッダに重複して現れる。（おそらく<code>CL:EQUALP</code>で比較されている）</li>
<li>文字列で指定した場合、文字ケースは無視されて正規化される。</li>
</ul>

<p>ドキュメントに何も記されていないのは不親切だと思う。</p>

<h5>body</h5>

<p>READMEに出てくる<code>(&quot;Hello, Clack!&quot;)</code>以外の情報が皆無である。
わざとエラーを起こして調べたところ、LISTかPATHNAMEか(VECTOR(UNSIGNED-BYTE 8))かのいずれかでないとだめらしい。</p>

<ul>
<li>LISTを返す場合、各要素は文字シーケンスでなければならず、各シーケンスが連結されて送られる。</li>
<li>pathnameを返す場合、そのファイルの中身がContent-Typeとして送られる。</li>
<li>(VECTOR(UNSIGNED-BYTE 8))を返す場合、それがContent-Typeとして送られる。</li>
</ul>

<p>ドキュメントに何も記されていないのは不親切だと思う。</p>

<h2>Controller and action</h2>

<p>RailsではControllerはクラスであり、そのパブリックメソッドをアクションとする。
Cavemanでは前節で見てきた<code>CAVEMAN2.ROUTE:DEFROUTE</code>マクロがControllerであり、かつアクションであろう。</p>

<p>Railsのスタイルを褒めて言えば「きれいに整理整頓されている」となろう。
悪く言えば「過剰に分割されている」とも言えよう。
Railsのスタイルを受け入れてしまえば、一つ一つはコンパクトであり、どこに何があるかはかなり明確だ。
ただスタイルになれるまではどこに何があるか、覚えなければならないものは多い。</p>

<p>Cavemanのスタイルはその逆で、悪く言うなら「とっちらかっている」となろう。
褒めて言えば「ほどよくまとまっている」とも言えよう。
ファイルの分割などはプログラマの責任として放置されている。
よってCaveman自体は最低限の分割しかしておらず、Caveman-projectの初期構造を把握するのは容易である。</p>

<p>これは良し悪しの問題ではなく向き不向きの問題だろう。
この場合の「向き不向き」は、プログラマ個々人の向き不向き、プロジェクトの大小による向き不向き、そしてチーム単位による向き不向きとがあろう。</p>

<h2>練習の準備</h2>

<p>web.lispに以下のroutingを定義する。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h2>STEP1 parameterの取得</h2>

<p>Cavemanではrouting-rule次第でパラメタの取扱が異なってくる。</p>

<h3>ディレクトリスタイル</h3>

<p>URIを&ldquo;/lesson/step1/Sato&rdquo;という形で受けたいなら、以下のようにする。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*/:name"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    <span class="paren3">(<span class="code">1 <span class="paren4">(<span class="code">format nil <span class="string">"Hello, ~A"</span> name</span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h3>クエリスタイル</h3>

<p>クエリパラメタで受けたい（e.g. &ldquo;/lesson/step1?name=Sato&rdquo;）なら以下のようにする。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat <span class="paren3">(<span class="code">|name| <span class="string">"Anonymous"</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    <span class="paren3">(<span class="code">1 <span class="paren4">(<span class="code">format nil <span class="string">"Hello, ~A"</span> |name|</span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h3>Railsスタイル</h3>

<p>Railsのようにどちらでも受けたいという場合、&apos;?&apos;でキーを囲む記法を利用する。
ただしここではワイルドカードを使ってしまっているので、組み合わせては使えない。</p>

<h2>STEP3 リダイレクション</h2>

<p>以下のようにする。
なおコードが大きくなるので一部省略している点要注意。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">3 '<span class="paren4">(<span class="code">302 <span class="paren5">(<span class="code"><span class="keyword">:location</span> <span class="string">"/lesson/step4"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">4 <span class="string">"Moved to step4"</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h2>STEP5 フラッシュ</h2>

<p>Cavemanではフラッシュに相当する機能は提供されていないようだ。
必要なら泥臭く自作する。
幸い<code>NINGLE/CONTEXT:*SESSION*</code>が提供されているのでさほど難しくはない。
<code>NINGLE/CONTEXT:*SESSION*</code>はハッシュテーブルで、各セッションごとに値を保持できる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">5 <span class="paren4">(<span class="code">setf<span class="paren5">(<span class="code">gethash <span class="keyword">:notice</span> <span class="special">*session*</span></span>)</span><span class="string">"Move to step6"</span></span>)</span>
     `<span class="paren4">(<span class="code">302 <span class="paren5">(<span class="code"><span class="keyword">:location</span> <span class="string">"/lesson/step6"</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">6 <span class="paren4">(<span class="code"><i><span class="symbol">let</span></i><span class="paren5">(<span class="code"><span class="paren6">(<span class="code">notice<span class="paren1">(<span class="code">gethash <span class="keyword">:notice</span> <span class="special">*session*</span></span>)</span></span>)</span></span>)</span>
         <span class="paren5">(<span class="code">remhash <span class="keyword">:notice</span> <span class="special">*session*</span></span>)</span>
         notice</span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h2>Template</h2>

<p>Cavemanではテンプレートエンジンとして<a href="https://github.com/mmontone/djula" >djula</a>を採用している。</p>

<h3>STEP7 Basic</h3>

<p>Contoroller側で以下のようにする。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">7 <span class="paren4">(<span class="code">render <span class="string">"step7.html"</span> `<span class="paren5">(<span class="code"><span class="keyword">:price</span> ,<span class="paren6">(<span class="code">floor<span class="paren1">(<span class="code">* 2000 1.08</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>templatesディレクトリ下に対応するhtmlファイルを作り以下のようにする。</p>

<pre><code>&lt;p&gt;{{price}}yen&lt;/p&gt;</code></pre>

<h3>STEP8 about YOUR-APP.VIEW:RENDER function.</h3>

<p>RENDER関数はsrc/view.lispに定義されている。
第一引数はテンプレートファイルの所在を表すPATHNAMEないしSTRINGである。
第二引数はオプショナルでテンプレートに渡す引数をリストにくくったものとなる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">8 <span class="paren4">(<span class="code">render <span class="string">"step7.html"</span> '<span class="paren5">(<span class="code"><span class="keyword">:price</span> 1000</span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<h3>STEP9 HTML特殊文字の変換</h3>

<p>RENDER関数に渡された文字列は通常エスケープ処理される。</p>

<p>Controllerは以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">9 <span class="paren4">(<span class="code">render <span class="string">"step9.html"</span> '<span class="paren5">(<span class="code"><span class="keyword">:comment</span> <span class="string">"&lt;script&gt;alert('danger')&lt;/script&gt;Hello"</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code>&lt;p&gt;{{comment}}&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-step9.png" alt="Screen shot of example" /></p>

<p>あえてHTMLを埋め込みたい場合はView側で変数参照の後ろにsafeをつける。</p>

<p>Controllerは以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">10 <span class="paren4">(<span class="code">render <span class="string">"step10.html"</span> '<span class="paren5">(<span class="code"><span class="keyword">:comment</span> <span class="string">"&lt;strong&gt;safe html&lt;/strong&gt;"</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code>&lt;p&gt;{{comment | safe}}&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-step10.png" alt="Screen shot of example" /></p>

<h2>philosophy of djula</h2>

<p>Cavemanのテンプレートエンジンはdjulaであり、djulaの哲学は「Viewはロジックを担うべきではない」だ。</p>

<p>たとえばRailsのテンプレートエンジンと異なり、djulaではView側で変数を作ったり代入したりができない。
変数は必ずRENDER経由で渡されたものでなくてはならない。</p>

<p>formatも一引数フィルターとしてしか使えない。
複雑な文字列はContoller側で作って渡せという考えである。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">11 `<span class="paren4">(<span class="code">200 <span class="paren5">(<span class="code"><span class="keyword">:content-type</span> <span class="string">"text/html; charset=utf-8"</span></span>)</span>
          <span class="paren5">(<span class="code">,<span class="paren6">(<span class="code"><i><span class="symbol">let</span></i><span class="paren1">(<span class="code"><span class="paren2">(<span class="code">population 704414</span>)</span>
                 <span class="paren2">(<span class="code">surface 141.31</span>)</span></span>)</span>
              <span class="paren1">(<span class="code">your-app.view:render <span class="string">"step11.html"</span> '<span class="paren2">(<span class="code"><span class="keyword">:contents</span> ,<span class="paren3">(<span class="code">format nil <span class="string">"人口~D人、面積~D平方キロ、人口密度~,,2F人/平方キロ"</span>
                                                                       population <span class="paren4">(<span class="code">floor surface</span>)</span><span class="paren4">(<span class="code">/ population surface</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>View側は以下の通り。</p>

<pre><code>&lt;p&gt;{{contents}}&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-step11.png" alt="Screen shot of example" /></p>

<p>日付については以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">12 <span class="paren4">(<span class="code">render <span class="string">"step11.html"</span>
                `<span class="paren5">(<span class="code"><span class="keyword">:contents</span> ,<span class="paren6">(<span class="code">local-time:format-timestring
                                nil
                                <span class="paren1">(<span class="code">local-time:now</span>)</span>
                                <span class="keyword">:format</span>
                                '<span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:year</span> 4</span>)</span><span class="string">"/"</span><span class="paren2">(<span class="code"><span class="keyword">:month</span> 2</span>)</span><span class="string">"/"</span><span class="paren2">(<span class="code"><span class="keyword">:day</span> 2</span>)</span><span class="string">"("</span> <span class="keyword">:short-weekday</span> <span class="string">") "</span>
                                  <span class="paren2">(<span class="code"><span class="keyword">:hour</span> 2</span>)</span><span class="string">":"</span><span class="paren2">(<span class="code"><span class="keyword">:min</span> 2</span>)</span><span class="string">":"</span><span class="paren2">(<span class="code"><span class="keyword">:sec</span> 2</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p><img src="../img/caveman/CkRoR-step12.png" alt="Screen shot of example" /></p>

<p>簡単なフィルターならdjula自身が持っている。</p>

<p>Controllerは以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">13 `<span class="paren4">(<span class="code">200 <span class="paren5">(<span class="code"><span class="keyword">:content-type</span> <span class="string">"text/html; charset=utf-8"</span></span>)</span>
          <span class="paren5">(<span class="code">,<span class="paren6">(<span class="code">render <span class="string">"step13.html"</span> '<span class="paren1">(<span class="code"><span class="keyword">:population</span> 127767944</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code>&lt;p&gt;人口{{ population | format: "~:D" }}人&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-step13.png" alt="Screen shot of example" /></p>

<p>なお、数字の表示が&apos;&quot;127,767,944&apos;というような形で、先頭にダブルクォートがついて表示されてしまうが、おそらくはこれはdjulaのバグである。
面倒なのでここでは無視する。</p>

<h2>カスタムフィルターの定義。</h2>

<p>djulaのドキュメントにはTODOとなっている。
公開されていない内部DSLだが、無理やり利用して自作フィルターを作ることとする。</p>

<p>view.lispに以下のコードを追加する。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">djula::def-filter</span></i> <span class="keyword">:break</span><span class="paren2">(<span class="code">it</span>)</span>
  <span class="paren2">(<span class="code">cl-ppcre:regex-replace-all <span class="character">#\newline</span> it <span class="string">"&lt;br /&gt;"</span></span>)</span></span>)</span></span></code></pre>

<p>Controller側は以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">14 <span class="paren4">(<span class="code">render <span class="string">"step14.html"</span> `<span class="paren5">(<span class="code"><span class="keyword">:contents</span> ,<span class="paren6">(<span class="code">format nil <span class="string">"foo~%bar~%bazz"</span></span>)</span></span>)</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>View側は以下の通り。</p>

<pre><code>&lt;p&gt;{{contents|break|safe}}&lt;/p&gt;</code></pre>

<p><img src="../img/caveman/CkRoR-step14.png" alt="Screen shot of example" /></p>

<h2>STEP15 Link</h2>

<p>いい具合にリンクを処理してくれる機能などない。</p>

<p>Controller側は以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    <span class="paren3">(<span class="code">15 <span class="paren4">(<span class="code">render <span class="string">"step15.html"</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>View側は以下の通り。
手でごりごり書くよりほかない。</p>

<pre><code>&lt;p&gt;&lt;a href="/"&gt;Home&lt;/a&gt;&lt;/p&gt;</code></pre>

<h2>Image</h2>

<p>画像をいい具合にリンクしてくれる機能などない。</p>

<p>まずは<a href="http://www.lisperati.com/lisplogo.svg" >ここ</a>から画像をダウンロードしておく。
保存箇所は&ldquo;static/images/&rdquo;とする。</p>

<p>Controllerは以下の通り。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">16 <span class="paren4">(<span class="code">render <span class="string">"step16.html"</span></span>)</span></span>)</span>
    </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code><span class="code">&lt;p&gt;Powered by&lt;img src="/images/lisplogo.svg" alt="lisplogo" align="top" width=60 height=20&gt;&lt;/p&gt;</span></code></pre>

<h2>条件分岐</h2>

<p>djulaで条件分岐は以下のようにして行う。</p>

<p>まずはControllerを。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">17 `<span class="paren4">(<span class="code">200 <span class="paren5">(<span class="code"><span class="keyword">:content-type</span> <span class="string">"text/html; charset=utf-8"</span></span>)</span>
          <span class="paren5">(<span class="code">,<span class="paren6">(<span class="code"><i><span class="symbol">let</span></i><span class="paren1">(<span class="code"><span class="paren2">(<span class="code">stock 0</span>)</span></span>)</span>
              <span class="paren1">(<span class="code">render <span class="string">"step17.html"</span> `<span class="paren2">(<span class="code"><span class="keyword">:stock-zerop</span> ,<span class="paren3">(<span class="code">&lt; 0 stock</span>)</span> <span class="keyword">:stock</span> ,stock</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code>{% if stock-zerop %}
残り{{stock}}個です。
{% else %}
品切れです。
{% endif %}</code></pre>

<h2>繰り返し</h2>

<p>djulaでの繰り返しは以下のようにする。</p>

<p>まずはControllerを。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/lesson/step*"</span><span class="paren2">(<span class="code">&amp;key splat name</span>)</span>
  <span class="paren2">(<span class="code">case<span class="paren3">(<span class="code">parse-integer <span class="paren4">(<span class="code">car splat</span>)</span> <span class="keyword">:junk-allowed</span> t</span>)</span>
    ...
    <span class="paren3">(<span class="code">18 <span class="paren4">(<span class="code">render <span class="string">"step18.html"</span> '<span class="paren5">(<span class="code"><span class="keyword">:items</span> <span class="paren6">(<span class="code"><span class="paren1">(<span class="code"><span class="keyword">:pan</span> . 2680</span>)</span><span class="paren1">(<span class="code"><span class="keyword">:glass</span> . 2550</span>)</span><span class="paren1">(<span class="code"><span class="keyword">:pepper-mill</span> . 4515</span>)</span><span class="paren1">(<span class="code"><span class="keyword">:peeler</span> . 945</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  </span>)</span></span>)</span></span></code></pre>

<p>Viewは以下の通り。</p>

<pre><code>&lt;table border="1" cellpadding="4"&gt;
        {% for (key . val) in items %}
        &lt;tr&gt;
                &lt;th&gt;{{key}}&lt;/th&gt;
                &lt;td style="text-align: right"&gt;{{val|format: "~:D"}}yen&lt;/td&gt;
        &lt;/tr&gt;
        {% endfor %}
&lt;/table&gt;</code></pre>

<h2>Mockup</h2>

<p>これまではテンプレートファイルを単独で使ってきた。</p>

<p>もちろんこれらは組み合わせて使うことができる。</p>

<p>下準備としてsrc/view.lispの末尾を以下のように編集する。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defpackage</span></i> your-app.djula
  <span class="paren2">(<span class="code"><span class="keyword">:use</span> <span class="keyword">:cl</span></span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:import-from</span> <span class="keyword">:your-app.config</span>
                <span class="keyword">:config</span>
                <span class="keyword">:appenv</span>
                <span class="keyword">:developmentp</span>
                <span class="keyword">:productionp</span></span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:import-from</span> <span class="keyword">:caveman2</span>
                <span class="keyword">:url-for</span></span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:export</span> <span class="keyword">#:title!</span></span>)</span> <span class="comment">; &lt;--- Add.
</span>  </span>)</span>

<span class="paren1">(<span class="code">in-package <span class="keyword">:your-app.djula</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">let</span></i><span class="paren2">(<span class="code">title</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">defun</span></i> title!<span class="paren3">(<span class="code">&amp;optional sub</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">if</span></i> sub
      <span class="paren4">(<span class="code">format nil <span class="string">"~@[~A - ~]~:(~A~)"</span><span class="paren5">(<span class="code">setf title sub</span>)</span> #.<span class="paren5">(<span class="code">asdf:coerce-name<span class="paren6">(<span class="code">asdf:find-system <span class="keyword">:your-app</span></span>)</span></span>)</span></span>)</span>
      title</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>なお、YOUR-APP.DJULAパッケージ下に関数を定義する場合、オブジェクトのスロット名と衝突しないよう注意すること。
これが衝突すると厄介なバグとなる。
バグの詳細についてはappendixで記す。</p>

<p>準備ができたらtemplates/layouts/下にレイアウトテンプレートファイルを作って以下のようにする。
ファイル名はdemo.htmlとした。</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;{% block title %}Your app{% endblock %}&lt;/title&gt;
  &lt;link rel="stylesheet" type="text/css" media="screen" href="/css/main.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  {% block content %}{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</code></pre>

<p>レイアウトテンプレートを使うには、各テンプレートファイルの先頭で使用すべきレイアウトテンプレートを指定しなければならない。
トップページのレイアウトを変更するには対応するテンプレートファイル（ここではtemplates/index.html）を以下のように編集する。</p>

<pre><code>{% extends "layouts/demo.html" %}
{% block title %}{% lisp (title! "subtitle") %}{% endblock %}
{% block content %}
&lt;h2&gt;{{message}}&lt;/h2&gt;
&lt;p&gt;Here we go.&lt;/p&gt;
{% endblock %}</code></pre>

<p>レイアウトテンプレートで宣言されている名前付きブロックを、各テンプレートで指定することで置換するという振る舞いである。</p>

<h2>レイアウトテンプレートの切り替え。</h2>

<p>おそらくはできない。
djulaはそのための機能を提供していないように見える。
どうしてもやりたいなら泥臭く自作するしかない。
ここでは無視する。</p>

<h2>部分テンプレート</h2>

<p>includeタグを使う。
ただし、親のコンテクストとはことなる独自の引数を渡したいならRENDER関数を呼び出すことで対応できる。</p>

<p>templates/layouts/下にapp.htmlテンプレートを作ろう。</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;title&gt;{% block title %}Your app{% endblock %}&lt;/title&gt;
        &lt;link rel="stylesheet" type="text/css" media="screen" href="/css/main.css"&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;div id="container"&gt;
                &lt;header&gt;
                        {% include "shared/header.html" %}
                &lt;/header&gt;
                &lt;main&gt;
                {% block content %}{% endblock %}
                &lt;/main&gt;
                &lt;aside id="sidebar"&gt;
                        {% lisp (your-app.view:render "shared/sidebar.html"
                                  '(:news (1 2 3 4 5)
                                    :blogs (1 2 3 4 5))) %}
                &lt;/aside&gt;
                &lt;footer&gt;
                        {% include "shared/footer.html" %}
                &lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

<p>templates/下にsharedディレクトリを掘り、部分テンプレートを記述していく。</p>

<p>まずはheader.html</p>

<pre><code>&lt;img src="images/lisplogo.svg" width="272" height="48" alt="Your app"&gt;

&lt;nav class="menubar"&gt;
        &lt;ul&gt;
                &lt;li&gt;&lt;a href="/"&gt;Home&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="#"&gt;News&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="#"&gt;Blog&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="#"&gt;Members&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href="#"&gt;Settings&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
&lt;/nav&gt;</code></pre>

<p>sidebar.html</p>

<pre><code>{% include "shared/login_form.html" %}

&lt;h2&gt;Latest news&lt;/h2&gt;
&lt;ul&gt;
        {% for n in news %}
        &lt;li&gt;&lt;a href="#"&gt;News header&lt;/a&gt;&lt;/li&gt;
        {% endfor %}
&lt;/ul&gt;

&lt;h2&gt;Member blog&lt;/h2&gt;
&lt;ul&gt;
        {% for b in blogs %}
        &lt;li&gt;&lt;a href="#"&gt;Blog header&lt;/a&gt;&lt;/li&gt;
        {% endfor %}
&lt;/ul&gt;</code></pre>

<p>login_form.html</p>

<pre><code>&lt;h2&gt;Login&lt;/h2&gt;
&lt;form id="login_form"&gt;
    &lt;div&gt;
        &lt;label&gt;user name:&lt;/label&gt;
        &lt;input type="text"&gt;
    &lt;/div&gt;
    &lt;div&gt;
        &lt;label&gt;password:&lt;/label&gt;
        &lt;input type="password"&gt;
    &lt;/div&gt;
    &lt;div&gt;
        &lt;input type="submit" value="Login"&gt;
    &lt;/div&gt;
&lt;/form&gt;</code></pre>

<p>footer.html</p>

<pre><code>&lt;a href="/about"&gt;About your app&lt;/a&gt;|
Copyright(C) &lt;a href="#"&gt;example.com&lt;/a&gt;
2007-2019</code></pre>

<p>Controller側を以下のようにする。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defroute</span></i> <span class="string">"/"</span> <span class="paren2">(<span class="code"></span>)</span>
  <span class="paren2">(<span class="code">render #P<span class="string">"index.html"</span> '<span class="paren3">(<span class="code"><span class="keyword">:numbers</span> <span class="paren4">(<span class="code">1 2 3 4 5</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p><img src="../img/caveman/CkRoR-layout.png" alt="Screen shot of example" /></p>

<h2>Stylesheet</h2>

<p>Cavemanではstatic/css/下に配置する。
ここではapp.cssという名前とする。</p>

<pre><code>/* whole pages */
body {
        background-color: white;
        color: black;
        margin: 0; padding: 0;
        font-family: Meiryo, sans-serif;
}

/* link */
a:link { color: #00c; }
a:visited { color: #00c; }
a:hover { color: #f00; }
a img { border: none; }

/* whole border */
div#container {
        margin: 0 auto;
        padding-top: 5px;
        width: 780px;
}

/* left pane */
main {
        float: left;
        width: 530px;
        padding: 10px, 10px, 10px, 0;
}

/* right pane */
aside#sidebar {
        float: left;
        width: 230px;
        background-color: #e8ffff;
        padding: 5px;
        font-size: 86%;
}

/* link of menubar */
nav.menubar a { text-decoration: none; }

/* link of menubar (not visited) */
nav.menubar a:link { color: #ccc; }

/* link of menubar (visited) */
nav.menubar a:visited { color: #ccc; }</code></pre>

<p><img src="../img/caveman/CkRoR-css.png" alt="Screen shot of example" /></p>

<h2>まとめ</h2>

<ul>
<li>Cavemanは、HTTPプロトコルでリクエストを受け取ると、ルーティングルールに従って関数（アクション）を呼び出します。</li>
<li>コントローラの中には、複数のアクションが含まれ得ます。コントローラもアクションもただの関数です。</li>
<li>アクション関数はSTRINGないしPATHNAMEないしLISTを返します。LISTの場合、HTTP-STATUS-CODE、HTTPレスポンスヘッダPLIST、bodyの3要素で、bodyは文字シーケンスのLISTないしPATHNAMEないし(VECTOR(UNSIGNED-BYTE 8))でなくてはなりません。</li>
<li>アクション関数ではRENDER関数を呼ぶことでDjulaテンプレートを利用したレンダリングが可能です。</li>
<li>テンプレートの中ではリキッドタグを使用する形でdjulaDSLを使用できます。</li>
<li>サイト中のページで共通して使う全体の枠を作るにはレイアウトテンプレートを利用します。ページ内のパーツは部分テンプレートで作成できます。</li>
<li>サイトの色やフォントはスタイルシートで設計します。</li>
</ul>

<h2>Appendix</h2>

<p>YOUR-APP.DJULAパッケージにある関数名とオブジェクトのスロット名が衝突すると厄介なバグが仕込まれる。
これはDJULAが依存している<a href="https://github.com/AccelerationNet/access" >ACCESS</a>の振る舞いに起因している。</p>

<p>ACCESSは引数が関数名だった場合、スロット名と解釈せず関数としてオブジェクトに適用するという振る舞いをする。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">access:access '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list 1 2 3</span>)</span></span>)</span> <span class="keyword">:list</span></span>)</span> <span class="comment">; ===&gt; (1 2 3)
</span><span class="paren1">(<span class="code">access:access '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list 1 2 3</span>)</span></span>)</span> 'list</span>)</span> <span class="comment">; ===&gt; (((list 1 2 3)))</span></span></code></pre>

<p>オブジェクトのスロット名が関数名と衝突した場合、そのスロットをACCESS経由で参照することは不可能となる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defclass</span></i> object <span class="paren2">(<span class="code"></span>)</span><span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list <span class="keyword">:initform</span> '<span class="paren4">(<span class="code">1 2 3</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code">access:access <span class="paren2">(<span class="code">make-instance 'object</span>)</span> <span class="keyword">:list</span></span>)</span> <span class="comment">; ===&gt; (#&lt;OBJECT ...&gt;)
</span><span class="paren1">(<span class="code">access:access <span class="paren2">(<span class="code">make-instance 'object</span>)</span> 'list</span>)</span> <span class="comment">; ===&gt; (#&lt;OBJECT ...&gt;)
</span><span class="paren1">(<span class="code">access:access <span class="paren2">(<span class="code">make-instance 'object</span>)</span> <span class="string">"list"</span></span>)</span> <span class="comment">; ===&gt; (#&lt;OBJECT ...&gt;)
</span><span class="paren1">(<span class="code">access:access <span class="paren2">(<span class="code">make-instance 'object</span>)</span> <span class="string">"LIST"</span></span>)</span> <span class="comment">; ===&gt; (#&lt;OBJECT ...&gt;)</span></span></code></pre>

<!-- {% endraw %} -->

    </MAIN>
    <FOOTER><A HREF='../indexes/index.html'>Index</A></FOOTER>
  </BODY>
</HTML>