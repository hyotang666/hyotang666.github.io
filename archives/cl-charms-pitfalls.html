<!DOCTYPE HTML>
<HTML>
  <HEAD>
    <TITLE>cl-charms-pitfalls</TITLE>
    <META CHARSET='UTF-8'>
    <META NAME='auhtor' CONTENT='hyotang666'>
    <META NAME='generator' CONTENT='pages'>
    <LINK REL='stylesheet' HREF='../css/css.css' TYPE='text/css'>
  </HEAD>
  <BODY>
    <MAIN>
      <h1>cl-charms pitfalls.</h1>

<h2>Meta notes.</h2>

<h3>対象読者</h3>

<ul>
<li>cl-charmsを使って日本語を表示したい方。</li>
</ul>

<h2>Introduction.</h2>

<p><a href="https://github.com/HiTECNOLOGYs/cl-charms" >cl-charms</a>を使って日本語を表示しようとしたら文字化けを起こしていました。
解決したので備忘録として記しておきます。</p>

<h2>Reason.</h2>

<p>原因はlocaleの初期化をしていないからでした。
<a href="https://linux.die.net/man/3/ncurses" >ncurses</a>のマニュアルによるとlocaleの設定がなされていない場合は後方互換製のためエンコーディングをiso-8859-1とみなすようです。</p>

<h2>How to initialize.</h2>

<p><a href="https://github.com/cxxxr/lem/tree/master/lib/setlocale" >lem-setlocale/cffi</a>を使います。
これは<a href="https://github.com/cxxxr/lem" >lem</a>のサブシステムです。</p>

<p>lem自体はquicklispに登録されていないので、<a href="https://github.com/roswell/roswell" >roswell</a>を使ってインストールしておきましょう。</p>

<pre><code><span class="code">* <span class="paren1">(<span class="code">lem-setlocale/cffi:setlocale lem-setlocale:+lc-all+ <span class="string">"en_US.UTF-8"</span></span>)</span></span></code></pre>

<p>上記コードでlocaleの初期化が可能です。</p>

<p>システムのlocaleを取り出したい場合は<a href="https://github.com/Shinmera/system-locale" >system-locale</a>が便利です。</p>

<h2>Pitfalls.</h2>

<h3>Missing cffi.</h3>

<p>2020/09/29現時点でlem-setlocale/cffiのasdファイルにはcffiが<code>:depends-on</code>に存在しません。
よって<code>lem-setlocale/cffi</code>のみをロードしようとするとエラーとなります。
事前に<code>cffi</code>のロードが必要です。</p>

<h3>Must setlocale before compile cl-charms.</h3>

<p>cl-charmsをコンパイルする前に<code>SETLOCALE</code>しなければなりません。</p>

<p>少々お行儀が悪いですがメソッドを追加して対応するのが簡単だと思います。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defsystem</span></i> <span class="string">"your-app"</span>
  <span class="keyword">:depends-on</span>
  <span class="paren2">(<span class="code">
   <span class="string">"cffi"</span>
   <span class="string">"lem-setlocale/cffi"</span>
   </span>)</span>
  ...</span>)</span>

<span class="comment">;; lem-setlocale/cffiをロード語にSETLOCALEを呼ぶ。
</span><span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> perform <span class="keyword">:after</span> <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">o load-op</span>)</span> <span class="paren3">(<span class="code">c <span class="paren4">(<span class="code">eql <span class="paren5">(<span class="code">find-system <span class="string">"lem-setlocale/cffi"</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">symbol-call <span class="string">"LEM-SETLOCALE/CFFI"</span> <span class="string">"SETLOCALE"</span>
               <span class="paren3">(<span class="code">symbol-value <span class="paren4">(<span class="code">find-symbol* <span class="string">"+LC-ALL+"</span> <span class="string">"LEM-SETLOCALE/CFFI"</span></span>)</span></span>)</span>
               <span class="string">"en_US.UTF-8"</span></span>)</span></span>)</span>

<span class="comment">;; lem-setlocale/cffiのロード後にcl-charmsがロードされるように指定。
</span><span class="paren1">(<span class="code"><i><span class="symbol">defmethod</span></i> component-depends-on <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">o load-op</span>)</span> <span class="paren3">(<span class="code">c <span class="paren4">(<span class="code">eql <span class="paren5">(<span class="code">find-system <span class="string">"lem-setlocale/cffi"</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="code">append <span class="paren3">(<span class="code">call-next-method</span>)</span> '<span class="paren3">(<span class="code"><span class="paren4">(<span class="code">load-op <span class="string">"cl-charms"</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h2>最後に。</h2>

<p>lem-setlocale/cffiが独立したライブラリになってくれると嬉しい。</p>

    </MAIN>
    <FOOTER><A HREF='../indexes/index.html'>Index</A></FOOTER>
  </BODY>
</HTML>