<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html>
  <head>
    <title>cl-vs-haskell.3
    </title>
    <meta http-equiv='content-type' content='text/html; charset=UTF-8' />
    <meta name='auhtor' content='hyotang666' />
    <meta name='generator' content='pages' />
<link rel='stylesheet' href='../css/css.css' type='text/css' />
  </head>
<body><h1>Common Lisp vs Haskell, Chapter 3</h1>

<h2>Meta note</h2>

<h3>対象読者</h3>

<p><a href="cl-vs-haskell.2.html" >前章</a>を読了済みの者。</p>

<h2>Introduction</h2>

<p>本稿は「すごいH本」の内容をCommon Lispに翻訳しながらCLerがHaskellを学ぶその第3章である。
本章では主にパターンマッチを使用したHaskellにおける関数定義構文を見ていき、それをCommon Lisp上に再現していく。
本章に於けるハイライトは、パターンマッチ（trivia）の導入、Haskellに於ける<code>where</code>キーワードをマクロで再現、リーダマクロの導入あたりだろうか。
中級CLerにとっては興味深い内容になっているのではないかと思われる。</p>

<h1>3</h1>

<h2>3.1</h2>

<h3>Pattern match</h3>

<pre><code><span class="code"><span class="function">lucky</span> <span class="keyword">::</span> <span class="variable">Int</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">lucky</span> 7 <span class="keyword">=</span> <span class="string">"LUCKY NUMBER SEVEN!"</span>
<span class="function">lucky</span> x <span class="keyword">=</span> <span class="string">"Sorry, you're out of luck, pal!"</span></span></code></pre>

<p>素のCommon Lispで書くと以下のようになる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">fixnum</span>)</span>string</span>)</span>lucky</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> lucy<span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">case x
    <span class="paren3">(<span class="code">7 <span class="string">"LUCKY NUMBER SEVEN!"</span></span>)</span>
    <span class="paren3">(<span class="code">t <span class="string">"Sorry, you're out of luck, pal!"</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>triviaを使うと、以下のようにも書ける。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> lucky<span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">7 <span class="string">"LUCKY NUMBER SEVEN!"</span></span>)</span>
  <span class="paren2">(<span class="code">_ <span class="string">"Sorry, you're out of luck, pal!"</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">sayMe</span> <span class="keyword">::</span> <span class="variable">Int</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">sayMe</span> 1 <span class="keyword">=</span> <span class="string">"One!"</span>
<span class="function">sayMe</span> 2 <span class="keyword">=</span> <span class="string">"Two!"</span>
<span class="function">sayMe</span> 3 <span class="keyword">=</span> <span class="string">"Three!"</span>
<span class="function">sayMe</span> 4 <span class="keyword">=</span> <span class="string">"Four!"</span>
<span class="function">sayMe</span> 5 <span class="keyword">=</span> <span class="string">"Five!"</span>
<span class="function">sayMe</span> x <span class="keyword">=</span> <span class="string">"Not between 1 and 5"</span></span></code></pre>

<p>この例に限っては素のCommon Lispで書く方が望ましいといえるかと思う。
<code>FORMAT</code>が反則的だが。
<code>(integer 1 5)</code>の部分は複合型指定子（Compound type specifier）といって、より特定的な型を指定するのに使えるものである。
Common Lispの<code>FIXNUM</code>は`<code>(ineger ,most-negative-fixnum ,most-positive-fixnum)</code>であると言える。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">fixnum</span>)</span>string</span>)</span>say-me</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> say-me<span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">typecase x
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">integer 1 5</span>)</span><span class="paren4">(<span class="code">format nil <span class="string">"~:(~R~)!"</span> x</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">t <span class="string">"Not betoween 1 and 5"</span></span>)</span></span>)</span></span>)</span>
<span class="comment">;; or
</span><span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> say-me<span class="paren2">(<span class="code">x</span>)</span>
  <span class="paren2">(<span class="code">1 <span class="string">"One!"</span></span>)</span>
  <span class="paren2">(<span class="code">2 <span class="string">"Two!"</span></span>)</span>
  <span class="paren2">(<span class="code">3 <span class="string">"Three!"</span></span>)</span>
  <span class="paren2">(<span class="code">4 <span class="string">"Four!"</span></span>)</span>
  <span class="paren2">(<span class="code">5 <span class="string">"Five!"</span></span>)</span>
  <span class="paren2">(<span class="code">_ <span class="string">"Not between 1 and 5"</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">factorial</span> <span class="keyword">::</span> <span class="variable">Int</span> <span class="keyword">-&gt;</span> <span class="variable">Int</span>
<span class="function">factorial</span> 0 <span class="keyword">=</span> 1
<span class="function">factorial</span> n <span class="keyword">=</span> n <span class="atom">*</span> factorial <span class="paren1">(<span class="code">n <span class="atom">-</span> 1</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">integer</span>)</span>integer</span>)</span>factorial</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> fuctorial<span class="paren2">(<span class="code">n</span>)</span>
  <span class="paren2">(<span class="code">case n
    <span class="paren3">(<span class="code">0 1</span>)</span>
    <span class="paren3">(<span class="code">t <span class="paren4">(<span class="code">* n <span class="paren5">(<span class="code">factorial <span class="paren6">(<span class="code">1- n</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
<span class="comment">;; or
</span><span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> factorial<span class="paren2">(<span class="code">n</span>)</span>
  <span class="paren2">(<span class="code">0 1</span>)</span>
  <span class="paren2">(<span class="code">_ <span class="paren3">(<span class="code">* n <span class="paren4">(<span class="code">factorial <span class="paren5">(<span class="code">1- n</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h3>Tuple pattern match</h3>

<pre><code><span class="code"><span class="function">addVectors</span> <span class="keyword">::</span> <span class="paren1">(<span class="code"><span class="variable">Double,</span> <span class="variable">Double</span></span>)</span> <span class="keyword">-&gt;</span> <span class="paren1">(<span class="code"><span class="variable">Double,</span> <span class="variable">Double</span></span>)</span> <span class="keyword">-&gt;</span> <span class="paren1">(<span class="code"><span class="variable">Double,</span> <span class="variable">Double</span></span>)</span>
<span class="function">addVectors</span> <span class="paren1">(<span class="code">x1, y1</span>)</span> <span class="paren1">(<span class="code">x2, y2</span>)</span> <span class="keyword">=</span> <span class="paren1">(<span class="code">x1 <span class="atom">+</span> x2, y1<span class="atom">+</span> y2</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype <span class="paren3">(<span class="code"><i><span class="symbol">function</span></i> <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">cons double-float double-float</span>)</span><span class="paren5">(<span class="code">cons double-float double-float</span>)</span></span>)</span>
                         <span class="paren4">(<span class="code">cons double-float double-float</span>)</span></span>)</span>
               add-vectors</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match*</span></i> add-vectors <span class="paren2">(<span class="code">c1 c2</span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">cons x1 y1</span>)</span><span class="paren4">(<span class="code">cons x2 y2</span>)</span></span>)</span> <span class="paren3">(<span class="code">cons <span class="paren4">(<span class="code">+ x1 x2</span>)</span><span class="paren4">(<span class="code">+ y1 y2</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h3>List pattern match, and list comprehension</h3>

<pre><code><span class="code"><span class="function">ghci</span><span class="atom">&gt;</span> <span class="keyword">let</span> xs <span class="keyword">=</span> <span class="paren1">[<span class="code"><span class="paren2">(<span class="code">1,3</span>)</span>,<span class="paren2">(<span class="code">4,3</span>)</span>,<span class="paren2">(<span class="code">2,4</span>)</span>,<span class="paren2">(<span class="code">5,3</span>)</span>,<span class="paren2">(<span class="code">5,6</span>)</span>,<span class="paren2">(<span class="code">3,1</span>)</span></span>]</span>
<span class="function">ghci</span><span class="atom">&gt;</span> <span class="paren1">[<span class="code">a<span class="atom">+</span>b <span class="keyword">|</span> <span class="paren2">(<span class="code">a, b</span>)</span> <span class="keyword">&lt;-</span> xs</span>]</span>
<span class="paren1">[<span class="code">4,7,6,8,11,4</span>]</span>
<span class="function">ghci</span><span class="atom">&gt;</span> <span class="paren1">[<span class="code">x<span class="atom">*</span>100<span class="atom">+</span>3 <span class="keyword">|</span> <span class="paren2">(<span class="code">x,3</span>)</span> <span class="keyword">&lt;-</span> xs</span>]</span>
<span class="paren1">[<span class="code">103,403,503</span>]</span></span></code></pre>

<p>incf-clの<code>LC</code>は分配束縛はサポートしているが、パターンマッチはサポートしていない。</p>

<pre><code><span class="code">cl-user&gt; <span class="paren1">(<span class="code"><i><span class="symbol">defvar</span></i> xs '<span class="paren2">(<span class="code"><span class="paren3">(<span class="code">1 3</span>)</span><span class="paren3">(<span class="code">4 3</span>)</span><span class="paren3">(<span class="code">2 4</span>)</span><span class="paren3">(<span class="code">5 3</span>)</span><span class="paren3">(<span class="code">5 6</span>)</span><span class="paren3">(<span class="code">3 1</span>)</span></span>)</span></span>)</span>
cl-user&gt; <span class="paren1">(<span class="code">incf-cl:lc <span class="paren2">(<span class="code">+ a b</span>)</span><span class="paren2">(<span class="code">incf-cl:&lt;- <span class="paren3">(<span class="code">a b</span>)</span> xs</span>)</span></span>)</span>
<span class="paren1">(<span class="code">4 7 6 8 11 4</span>)</span>
cl-user&gt; <span class="paren1">(<span class="code">incf-cl:lc <span class="paren2">(<span class="code">+ 3 <span class="paren3">(<span class="code">* x 100</span>)</span></span>)</span> <span class="paren2">(<span class="code">incf-cl:&lt;- <span class="paren3">(<span class="code">x 3</span>)</span> '<span class="paren3">(<span class="code"><span class="paren4">(<span class="code">1 3</span>)</span><span class="paren4">(<span class="code">4 3</span>)</span><span class="paren4">(<span class="code">2 4</span>)</span><span class="paren4">(<span class="code">5 3</span>)</span><span class="paren4">(<span class="code">5 6</span>)</span><span class="paren4">(<span class="code">3 1</span>)</span></span>)</span></span>)</span></span>)</span>
<span class="comment">;; ERROR
</span><span class="comment">;; incf-cl provides binding only, not pattern matching.
</span>cl-user&gt; <span class="paren1">(<span class="code">incf-cl:lc <span class="paren2">(<span class="code">+ 3 <span class="paren3">(<span class="code">* x 100</span>)</span></span>)</span> <span class="paren2">(<span class="code">incf-cl:&lt;- <span class="paren3">(<span class="code">x y</span>)</span> '<span class="paren3">(<span class="code"><span class="paren4">(<span class="code">1 3</span>)</span><span class="paren4">(<span class="code">4 3</span>)</span><span class="paren4">(<span class="code">2 4</span>)</span><span class="paren4">(<span class="code">5 3</span>)</span><span class="paren4">(<span class="code">5 6</span>)</span><span class="paren4">(<span class="code">3 1</span>)</span></span>)</span></span>)</span>
                     <span class="paren2">(<span class="code">= y 3</span>)</span></span>)</span>
<span class="paren1">(<span class="code">103 403 503</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">head'</span> <span class="keyword">::</span> <span class="paren1">[<span class="code">a</span>]</span> <span class="keyword">-&gt;</span> a
<span class="function">haed'</span> <span class="paren1">[<span class="code"></span>]</span> <span class="keyword">=</span> error <span class="string">"Can't call head on an empty list, dummy!"</span>
<span class="function">head'</span> <span class="paren1">(<span class="code">x<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> x</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>t</span>)</span>head</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> head <span class="paren2">(<span class="code">list</span>)</span>
 <span class="paren2">(<span class="code">nil <span class="paren3">(<span class="code">error <span class="string">"Can't call head on an empty list, dummy!"</span></span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">cons x _</span>)</span>x</span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">tell</span> <span class="keyword">::</span> <span class="paren1">(<span class="code"><span class="variable">Show</span> a</span>)</span> <span class="atom">=&gt;</span> <span class="paren1">[<span class="code">a</span>]</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">tell</span> <span class="paren1">[<span class="code"></span>]</span> <span class="keyword">=</span> <span class="string">"The list is empty"</span>
<span class="function">tell</span> <span class="paren1">(<span class="code">x<span class="variable">:</span><span class="paren2">[<span class="code"></span>]</span></span>)</span> <span class="keyword">=</span> <span class="string">"The list has one element: "</span> <span class="atom">++</span> show x
<span class="function">tell</span> <span class="paren1">(<span class="code">x<span class="variable">:</span>y<span class="variable">:</span><span class="paren2">[<span class="code"></span>]</span></span>)</span> <span class="keyword">=</span> <span class="string">"The list has two elements: "</span> <span class="atom">++</span> show x <span class="atom">++</span> <span class="string">" and "</span><span class="atom">++</span> show y
<span class="function">tell</span> <span class="paren1">(<span class="code">x<span class="variable">:</span>y<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> <span class="string">"This list is long. The first two elements are: "</span> <span class="atom">++</span> show x <span class="atom">++</span> <span class="string">" and "</span> <span class="atom">++</span> show y</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>string</span>)</span>tell</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> tell<span class="paren2">(<span class="code">list</span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"></span>)</span> <span class="string">"The list is empty"</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list x</span>)</span><span class="paren3">(<span class="code">format nil <span class="string">"The list has one elememt: ~S"</span> x</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list x y</span>)</span><span class="paren3">(<span class="code">format nil <span class="string">"The list has two elements: ~S and ~S"</span>x y</span>)</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">list* x y _</span>)</span><span class="paren3">(<span class="code">format nil <span class="string">"This list is long. The first two elements are: ~S and ~S"</span> x y</span>)</span></span>)</span></span>)</span></span></code></pre>

<h3>as pattern</h3>

<pre><code><span class="code"><span class="function">firstLetter</span> <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">firstLetter</span> <span class="string">""</span> <span class="keyword">=</span> <span class="string">"Empty string, whoops!"</span>
<span class="function">firstLetter</span> all<span class="keyword">@</span><span class="paren1">(<span class="code">x<span class="variable">:</span>xs</span>)</span> <span class="keyword">=</span> <span class="string">"The first letter of "</span> <span class="atom">++</span> all <span class="atom">++</span> <span class="string">" is "</span> <span class="atom">++</span> <span class="paren1">[<span class="code">x</span>]</span></span></code></pre>

<p>Triviaを使う場合、明示的に仮引数を書くことになるので、必要はなさそうだ。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">string</span>)</span>string</span>)</span>first-letter</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">trivia:defun-match</span></i> first-letter<span class="paren2">(<span class="code">all</span>)</span>
 <span class="paren2">(<span class="code"><span class="string">""</span> <span class="string">"Empty string, whoops!"</span></span>)</span>
 <span class="paren2">(<span class="code"><span class="paren3">(<span class="code">trivia:vector* x _</span>)</span><span class="paren3">(<span class="code">uiop:strcat <span class="string">"The first letter of "</span> all <span class="string">" is "</span> x</span>)</span></span>)</span></span>)</span></span></code></pre>

<h2>3.2</h2>

<h3>guard</h3>

<pre><code><span class="code"><span class="function">bmiTell</span> <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">bmiTell</span> bmi
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 18<span class="atom">.</span>5 <span class="keyword">=</span> <span class="string">"You're underweight, you emo, you!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 25<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 30<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're fat! Lose some weight, fatty!"</span>
&nbsp;  <span class="keyword">|</span> otherwise   <span class="keyword">=</span> <span class="string">"You're a whale, congratulations!"</span></span></code></pre>

<p>ガードは<code>COND</code>で再現できる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">float</span>)</span>string</span>)</span>bmi-tell</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">bmi</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">cond</span></i>
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
    <span class="paren3">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h2>3.3</h2>

<h3>where</h3>

<pre><code><span class="code"><span class="function">bmiTell</span> <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">bmiTell</span> weight height
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 18<span class="atom">.</span>5 <span class="keyword">=</span> <span class="string">"You're underweight, you emo, you!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 25<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 30<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're fat! Lose some weight, fatty!"</span>
&nbsp;  <span class="keyword">|</span> otherwise   <span class="keyword">=</span> <span class="string">"You're a whale, congratulations!"</span>
&nbsp;  <span class="keyword">where</span> bmi <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2</span></code></pre>

<p>Haskellの<code>where</code>はCommon Lispの<code>LET</code>にあたるだろうが、筆記順が異なってしまう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">float float</span>)</span>string</span>)</span>bmi-tell</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">bmi<span class="paren5">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren4">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p><code>LAMBDA</code>を利用することで前方参照のように書くこともできなくはない。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren4">(<span class="code">bmi</span>)</span>
     <span class="paren4">(<span class="code"><i><span class="symbol">cond</span></i>
       <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
       <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
       <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
       <span class="paren5">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span></span>)</span>
   <span class="paren3">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>マクロを設計するなら以下のようになるだろうか。</p>

<pre><code><span class="code">#+design
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren4">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span>
    <span class="keyword">:where</span> <span class="paren3">(<span class="code">bmi<span class="paren4">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span></span>)</span>
#+expanded
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">bmi<span class="paren5">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren4">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>また、リーダマクロを利用することで以下のような表記に発展させることも可能だろう。</p>

<pre><code><span class="code">#+design-with-reader-macro
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  #{<span class="paren2">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 18.5</span>)</span> <span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 25.0</span>)</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">&lt;= bmi 30.0</span>)</span> <span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren3">(<span class="code">t             <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span>
    <span class="keyword">:where</span> <span class="paren2">(<span class="code">bmi<span class="paren3">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span>}</span>)</span></span></code></pre>

<p>実装は後回しにしてもう少し<code>where</code>の機能を見て行きたい。</p>

<h3>pattern match with where</h3>

<pre><code><span class="code"><span class="atom">...</span>
&nbsp; <span class="keyword">where</span> bmi <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2
&nbsp;       <span class="paren1">(<span class="code">skinny, normal, fat</span>)</span> <span class="keyword">=</span> <span class="paren1">(<span class="code">18<span class="atom">.</span>5, 25<span class="atom">.</span>0, 30<span class="atom">.</span>0</span>)</span></span></code></pre>

<p>それがパターンマッチでなく、ただの分配束縛であるならmetabang-bindの<code>BIND</code>などが利用できよう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">bind:bind<span class="paren2">(<span class="code"><span class="paren3">(<span class="code">bmi <span class="paren4">(<span class="code">infix-math:$ weight / height ^ 2</span>)</span></span>)</span>
           <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">skinny normal fat</span>)</span>'<span class="paren4">(<span class="code">18.5 25.0 30.0</span>)</span></span>)</span></span>)</span>
  ...</span>)</span></span></code></pre>

<p>素のCommon Lispでなら、以下のような展開系が考えられる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren3">(<span class="code">bmi</span>)</span>
   <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren5">(<span class="code">skinny normal fat</span>)</span>
       ...</span>)</span>
    18.5 25.0 30.0</span>)</span></span>)</span>
 <span class="paren2">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">initials</span> <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">intials</span> firstname lastname <span class="keyword">=</span> <span class="paren1">[<span class="code">f</span>]</span> <span class="atom">++</span> <span class="string">". "</span> <span class="atom">++</span> <span class="paren1">[<span class="code">l</span>]</span> <span class="atom">++</span> <span class="string">"."</span>
&nbsp; <span class="keyword">where</span> <span class="paren1">(<span class="code">f<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> firstname
&nbsp;       <span class="paren1">(<span class="code">l<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> lastname</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">string string</span>)</span>string</span>)</span>initials</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> initials<span class="paren2">(<span class="code">firstname lastname</span>)</span>
  <span class="paren2">(<span class="code">bind:bind<span class="paren3">(<span class="code"><span class="paren4">(<span class="code">#<span class="paren5">(<span class="code">f _</span>)</span>firstname</span>)</span>
             <span class="paren4">(<span class="code">#<span class="paren5">(<span class="code">l _</span>)</span>lastname</span>)</span></span>)</span>
    <span class="paren3">(<span class="code">uiop:strcat f <span class="string">". "</span> l <span class="string">"."</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h3>Function in where block</h3>

<pre><code><span class="code"><span class="function">calcBmis</span> <span class="keyword">::</span> <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="variable">Double,</span> <span class="variable">Double</span></span>)</span></span>]</span> <span class="keyword">-&gt;</span> <span class="paren1">[<span class="code"><span class="variable">Double</span></span>]</span>
<span class="function">calcBmis</span> xs <span class="keyword">=</span> <span class="paren1">[<span class="code">bmi w h <span class="keyword">|</span> <span class="paren2">(<span class="code">w, h</span>)</span> <span class="keyword">&lt;-</span> xs</span>]</span>
&nbsp;   <span class="keyword">where</span> bmi weight height <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2</span></code></pre>

<p>関数を束縛する<code>where</code>節は、Common Lispでなら<code>FLET</code>で書くべきものだろう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>list</span>)</span>calc-bmis</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> calc-bmis<span class="paren2">(<span class="code">list</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">flet</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">bmi<span class="paren5">(<span class="code">weight height</span>)</span>
          <span class="paren5">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">incf-cl:lc <span class="paren4">(<span class="code">bmi w h</span>)</span> <span class="paren4">(<span class="code">incf-cl:&lt;- <span class="paren5">(<span class="code">w h</span>)</span> list</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p><code>LAMBDA</code>を利用して前方参照しようとする場合、<code>FUNCALL</code>が必要になってしまうのがブサイクである。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> calc-bmis<span class="paren2">(<span class="code">list</span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren4">(<span class="code">bmi</span>)</span><span class="paren4">(<span class="code">incf-cl:lc <span class="paren5">(<span class="code">funcall bmi w h</span>)</span><span class="paren5">(<span class="code">incf-cl:&lt;- <span class="paren6">(<span class="code">w h</span>)</span>list</span>)</span></span>)</span></span>)</span>
   <span class="paren3">(<span class="code"><i><span class="symbol">lambda</span></i><span class="paren4">(<span class="code">weight height</span>)</span><span class="paren4">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p><code>MACROLET</code>を利用すれば何とかならなくもない。</p>

<pre><code>(defun calc-bmis(list)
  (macrolet((bmi(w h)`(funcall fun ,w ,h)))
   ((lambda(fun)(incf-cl:lc (bmi w h)(incf-cl:&lt;- (w h)list)))
    (lambda(weight height)(infix-math:$ weight / height infix-math:^ 2)))))</code></pre>

<p>だが、まぁ、素直に<code>FLET</code>を書けという案件ではある。</p>

<h2>3.4</h2>

<h3>Let</h3>

<pre><code><span class="code"><span class="function">cylinder</span> <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span>
<span class="function">cylinder</span> r h <span class="keyword">=</span>
&nbsp;  <span class="keyword">let</span> sideArea <span class="keyword">=</span> 2 <span class="atom">*</span> pi <span class="atom">*</span> r <span class="atom">*</span> h
&nbsp;      topArea <span class="keyword">=</span> pi <span class="atom">*</span> r <span class="atom">^</span> 2
&nbsp;  <span class="keyword">in</span>  sideArea <span class="atom">+</span> 2 <span class="atom">*</span> topArea</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">float float</span>)</span>float</span>)</span>cylinder</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> cylinder<span class="paren2">(<span class="code">r h</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">side-area<span class="paren5">(<span class="code">infix-math:$ 2 * pi * r * h</span>)</span></span>)</span>
       <span class="paren4">(<span class="code">top-area <span class="paren5">(<span class="code">infix-math:$ pi * r infix-math:^ 2</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">infix-math:$ side-area + 2 * top-area</span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">ghci</span><span class="atom">&gt;</span> 4 <span class="atom">*</span> <span class="paren1">(<span class="code"><span class="keyword">let</span> a <span class="keyword">=</span> 9 <span class="keyword">in</span> a <span class="atom">+</span> 1</span>)</span> <span class="atom">+</span> 2</span></code></pre>

<pre><code><span class="code">cl-user&gt; <span class="paren1">(<span class="code">+ <span class="paren2">(<span class="code">* 4 <span class="paren3">(<span class="code"><i><span class="symbol">let</span></i><span class="paren4">(<span class="code"><span class="paren5">(<span class="code">a 9</span>)</span></span>)</span>
                   <span class="paren4">(<span class="code">1+ a</span>)</span></span>)</span></span>)</span>
            2</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">ghci</span><span class="atom">&gt;</span> <span class="paren1">[<span class="code"><span class="keyword">let</span> square x <span class="keyword">=</span> x <span class="atom">*</span> x <span class="keyword">in</span> <span class="paren2">(<span class="code">square 5, square 3, square 2</span>)</span></span>]</span></span></code></pre>

<p>Common Lispでローカル関数を定義する場合は<code>FLET</code>か<code>LABELS</code>を使う。</p>

<pre><code><span class="code">cl-user&gt; <span class="paren1">(<span class="code"><i><span class="symbol">flet</span></i><span class="paren2">(<span class="code"><span class="paren3">(<span class="code">square<span class="paren4">(<span class="code">x</span>)</span>
                 <span class="paren4">(<span class="code">* x x</span>)</span></span>)</span></span>)</span>
           `<span class="paren2">(<span class="code">,<span class="paren3">(<span class="code">square 5</span>)</span>,<span class="paren3">(<span class="code">square 3</span>)</span>,<span class="paren3">(<span class="code">square 2</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>このように見ていくと、Common Lispでは変数と関数の区別があるのが割と厄介だと言える。
Haskellの持つ、変数に見えるかもしれないが無引数の定数関数であるという考え方はものごとをシンプルにしてくれる。
そして、彼らが著しく括弧を嫌うのも、変数参照のたびに括弧で括りたくないと考えれば得心のいくものだ。</p>

<pre><code><span class="code"><span class="function">ghci</span><span class="atom">&gt;</span> <span class="paren1">(<span class="code"><span class="keyword">let</span> a <span class="keyword">=</span> 100; b <span class="keyword">=</span> 200; c <span class="keyword">=</span> 300 <span class="keyword">in</span> a<span class="atom">*</span>b<span class="atom">*</span>c, <span class="keyword">let</span> foo<span class="keyword">=</span><span class="string">"Hey "</span>; bar<span class="keyword">=</span><span class="string">"there!"</span> <span class="keyword">in</span> foo <span class="atom">++</span> bar</span>)</span></span></code></pre>

<pre><code><span class="code">cl-user&gt; `<span class="paren1">(<span class="code">,<span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">a 100</span>)</span>
                 <span class="paren4">(<span class="code">b 200</span>)</span>
                 <span class="paren4">(<span class="code">c 300</span>)</span></span>)</span>
              <span class="paren3">(<span class="code">* a b c</span>)</span></span>)</span>
           ,<span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">foo <span class="string">"Hey"</span></span>)</span>
                 <span class="paren4">(<span class="code">bar <span class="string">"there!"</span></span>)</span></span>)</span>
              <span class="paren3">(<span class="code">uiop:strcat foo bar</span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">ghci</span><span class="atom">&gt;</span> <span class="paren1">(<span class="code"><span class="keyword">let</span><span class="paren2">(<span class="code">a,b,c</span>)</span> <span class="keyword">=</span> <span class="paren2">(<span class="code">1,2,3</span>)</span> <span class="keyword">in</span> a<span class="atom">+</span>b<span class="atom">+</span>c</span>)</span> <span class="atom">*</span> 100
<span class="function">600</span></span></code></pre>

<p>Common Lispで分配束縛を行う場合は<code>DESTRUCTURING-BIND</code>を使う。</p>

<pre><code><span class="code">cl-user&gt; <span class="paren1">(<span class="code">destructuring-bind<span class="paren2">(<span class="code">a b c</span>)</span>'<span class="paren2">(<span class="code">1 2 3</span>)</span>
           <span class="paren2">(<span class="code">* <span class="paren3">(<span class="code">+ a b c</span>)</span>
              100</span>)</span></span>)</span>
600</span></code></pre>

<h3>Let in the list comprehension</h3>

<pre><code><span class="code"><span class="function">calcBmis</span> <span class="keyword">::</span> <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="variable">Double</span></span>)</span>,<span class="paren2">(<span class="code"><span class="variable">Double</span></span>)</span></span>]</span> <span class="keyword">-&gt;</span> <span class="paren1">[<span class="code"><span class="variable">Double</span></span>]</span>
<span class="function">calcBmis</span> xs <span class="keyword">=</span> <span class="paren1">[<span class="code">bmi <span class="keyword">|</span> <span class="paren2">(<span class="code">w, h</span>)</span> <span class="keyword">&lt;-</span> xs, <span class="keyword">let</span> bmi <span class="keyword">=</span> w <span class="atom">/</span> h <span class="atom">^</span> 2</span>]</span></span></code></pre>

<p>incf-clの<code>LC</code>には上記のようにしてローカル変数を束縛する構文は提供されていない。
素の<code>LOOP</code>マクロで割と充分と思う。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>list</span>)</span>calc-bmis</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> calc-bmis<span class="paren2">(<span class="code">xs</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">flet</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">bmi<span class="paren5">(<span class="code">w h</span>)</span><span class="paren5">(<span class="code">infix-math:$ w / h infix-math:^ 2</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">loop</span></i> <span class="keyword">:for</span> <span class="paren4">(<span class="code">w . h</span>)</span> <span class="keyword">:in</span> xs <span class="keyword">:collect</span> <span class="paren4">(<span class="code">bmi w h</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">calcBmis</span> <span class="keyword">::</span> <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="variable">Double</span></span>)</span>,<span class="paren2">(<span class="code"><span class="variable">Double</span></span>)</span></span>]</span> <span class="keyword">-&gt;</span> <span class="paren1">[<span class="code"><span class="variable">Double</span></span>]</span>
<span class="function">calcBmis</span> xs <span class="keyword">=</span> <span class="paren1">[<span class="code">bmi <span class="keyword">|</span> <span class="paren2">(<span class="code">w, h</span>)</span> <span class="keyword">&lt;-</span> xs, <span class="keyword">let</span> bmi <span class="keyword">=</span> w <span class="atom">/</span> h <span class="atom">^</span> 2, bmi <span class="atom">&gt;</span> 25<span class="atom">.</span>0</span>]</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>list</span>)</span>calc-bmis</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> calc-bmis<span class="paren2">(<span class="code">xs</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">loop</span></i> <span class="keyword">:for</span> <span class="paren3">(<span class="code">w . h</span>)</span> <span class="keyword">:in</span> xs
        <span class="keyword">:for</span> bmi = <span class="paren3">(<span class="code">infix-math:$ w / h infix-math:^ 2</span>)</span>
        <span class="keyword">:when</span> <span class="paren3">(<span class="code">&gt; bmi 25.0</span>)</span>
        <span class="keyword">:collect</span> bmi</span>)</span></span>)</span></span></code></pre>

<h2>3.5</h2>

<h3>case</h3>

<pre><code><span class="code"><span class="function">describeList</span> <span class="keyword">::</span> <span class="paren1">[<span class="code">a</span>]</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">desribeList</span> ls <span class="keyword">=</span> <span class="string">"The list is "</span>
&nbsp;                <span class="atom">++</span> <span class="keyword">case</span> ls <span class="keyword">of</span> <span class="paren1">[<span class="code"></span>]</span> <span class="keyword">-&gt;</span> <span class="string">"empty."</span>
&nbsp;                              <span class="paren1">[<span class="code">x</span>]</span> <span class="keyword">-&gt;</span> <span class="string">"a singleton list."</span>
&nbsp;                              xs <span class="keyword">-&gt;</span> <span class="string">"a longer list."</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>string</span>)</span>descirbe-list</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> describe-list<span class="paren2">(<span class="code">list</span>)</span>
  <span class="paren2">(<span class="code">uiop:strcat <span class="string">"The list is "</span> <span class="paren3">(<span class="code">etypecase list
                                <span class="paren4">(<span class="code">null <span class="string">"empty."</span></span>)</span>
                                <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">cons T null</span>)</span> <span class="string">"a singleton list."</span></span>)</span>
                                <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">cons t t</span>)</span> <span class="string">"a longer list."</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">describeList</span> <span class="keyword">::</span> <span class="paren1">[<span class="code">a</span>]</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">desribeList</span> ls <span class="keyword">=</span> <span class="string">"The list is "</span> <span class="atom">++</span> what ls
&nbsp;   <span class="keyword">where</span> what <span class="paren1">[<span class="code"></span>]</span> <span class="keyword">=</span> <span class="string">"empty."</span>
&nbsp;         what <span class="paren1">[<span class="code">x</span>]</span> <span class="keyword">=</span> <span class="string">"singleton list."</span>
&nbsp;         what xs <span class="keyword">=</span> <span class="string">"a longer list."</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>string</span>)</span>descirbe-list</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> describe-list<span class="paren2">(<span class="code">list</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">flet</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">what<span class="paren5">(<span class="code">x</span>)</span>
          <span class="paren5">(<span class="code">etypecase x
            <span class="paren6">(<span class="code">null <span class="string">"empty."</span></span>)</span>
            <span class="paren6">(<span class="code"><span class="paren1">(<span class="code">cons t null</span>)</span><span class="string">"singleton list."</span></span>)</span>
            <span class="paren6">(<span class="code"><span class="paren1">(<span class="code">cons t t</span>)</span> <span class="string">"a longer list."</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="code">uiop:strcat <span class="string">"The list is "</span> <span class="paren4">(<span class="code">waht list</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h2>Implement where keyword.</h2>

<p>さて、<code>where</code>の実装だが、metabang-bindに依存して作ってしまおう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defmacro</span></i> <i><span class="symbol">with-forward-reference</span></i><span class="paren2">(<span class="code">&amp;body body</span>)</span>
  <span class="paren2">(<span class="code">destructuring-bind<span class="paren3">(<span class="code">body binds</span>)</span><span class="paren3">(<span class="code">split-sequence:split-sequence <span class="keyword">:where</span> body</span>)</span>
    `<span class="paren3">(<span class="code">BIND:BIND,binds
       ,@body</span>)</span></span>)</span></span>)</span></span></code></pre>

<p>実装は以上。</p>

<p>これは筆者個人のコーディングルールで、他に同様の作法で書いてあるコードを見たことが無いので念の為説明しておくが、大文字で書かれている部分は静的にそのまま埋め込まれるリテラル部で、小文字で書かれてある部分（カンマの後）は動的に生成される部分を表している。
ACLなんかでは動かないかもしれないので要注意。</p>

<p>これで以下のように書けるようになる。</p>

<pre><code><span class="code"><span class="function">bmiTell</span> <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">bmiTell</span> weight height
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 18<span class="atom">.</span>5 <span class="keyword">=</span> <span class="string">"You're underweight, you emo, you!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 25<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> 30<span class="atom">.</span>0 <span class="keyword">=</span> <span class="string">"You're fat! Lose some weight, fatty!"</span>
&nbsp;  <span class="keyword">|</span> otherwise   <span class="keyword">=</span> <span class="string">"You're a whale, congratulations!"</span>
&nbsp;  <span class="keyword">where</span> bmi <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">double-float double-float</span>)</span>string</span>)</span>bmi-tell</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 18.5</span>)</span><span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 25.0</span>)</span><span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi 30.0</span>)</span><span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren4">(<span class="code">T            <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span>
    <span class="keyword">:where</span>
    <span class="paren3">(<span class="code">bmi <span class="paren4">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">bmiTell</span> <span class="keyword">::</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">Double</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">bmiTell</span> weight height
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> skinny <span class="keyword">=</span> <span class="string">"You're underweight, you emo, you!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> normal <span class="keyword">=</span> <span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span>
&nbsp;  <span class="keyword">|</span> bmi <span class="atom">&lt;=</span> fat    <span class="keyword">=</span> <span class="string">"You're fat! Lose some weight, fatty!"</span>
&nbsp;  <span class="keyword">|</span> otherwise   <span class="keyword">=</span> <span class="string">"You're a whale, congratulations!"</span>
&nbsp;  <span class="keyword">where</span> bmi <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2
&nbsp;        <span class="paren1">(<span class="code">skinny, normal, fat</span>)</span> <span class="keyword">=</span> <span class="paren1">(<span class="code">18<span class="atom">.</span>5, 25<span class="atom">.</span>0, 30<span class="atom">.</span>0</span>)</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">double-float double-float</span>)</span>string</span>)</span>bmi-tell</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> bmi-tell<span class="paren2">(<span class="code">weight height</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code"><i><span class="symbol">cond</span></i>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi skinny</span>)</span><span class="string">"You're underweight, you emo, you!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi normal</span>)</span><span class="string">"You're supposedly normal. Pffft, I bet you're ugly!"</span></span>)</span>
      <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">&lt;= bmi fat</span>)</span><span class="string">"You're fat! Lose some weight, fatty!"</span></span>)</span>
      <span class="paren4">(<span class="code">T            <span class="string">"You're a whale, congratulations!"</span></span>)</span></span>)</span>
    <span class="keyword">:where</span>
    <span class="paren3">(<span class="code">bmi <span class="paren4">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span>
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code">skinny normal fat</span>)</span> '<span class="paren4">(<span class="code">18.5 25.0 30.0</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">initials</span> <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">intials</span> firstname lastname <span class="keyword">=</span> <span class="paren1">[<span class="code">f</span>]</span> <span class="atom">++</span> <span class="string">". "</span> <span class="atom">++</span> <span class="paren1">[<span class="code">l</span>]</span> <span class="atom">++</span> <span class="string">"."</span>
&nbsp; <span class="keyword">where</span> <span class="paren1">(<span class="code">f<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> firstname
&nbsp;       <span class="paren1">(<span class="code">l<span class="variable">:</span>_</span>)</span> <span class="keyword">=</span> lastname</span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">string string</span>)</span>string</span>)</span>initials</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> initials<span class="paren2">(<span class="code">firstname lastname</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code">uiop:strcat f <span class="string">". "</span> l <span class="string">"."</span></span>)</span>
    <span class="keyword">:where</span>
    <span class="paren3">(<span class="code">#<span class="paren4">(<span class="code">f _</span>)</span>firstname</span>)</span>
    <span class="paren3">(<span class="code">#<span class="paren4">(<span class="code">l _</span>)</span>lastname</span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">calcBmis</span> <span class="keyword">::</span> <span class="paren1">[<span class="code"><span class="paren2">(<span class="code"><span class="variable">Double,</span> <span class="variable">Double</span></span>)</span></span>]</span> <span class="keyword">-&gt;</span> <span class="paren1">[<span class="code"><span class="variable">Double</span></span>]</span>
<span class="function">calcBmis</span> xs <span class="keyword">=</span> <span class="paren1">[<span class="code">bmi w h <span class="keyword">|</span> <span class="paren2">(<span class="code">w, h</span>)</span> <span class="keyword">&lt;-</span> xs</span>]</span>
&nbsp;   <span class="keyword">where</span> bmi weight height <span class="keyword">=</span> weight <span class="atom">/</span> height <span class="atom">^</span> 2</span></code></pre>

<p>metabang-bindに依存しているので、ローカル関数を作る場合など、metabang-bindのシンタックスに従う必要がある。
が、自分で実装することを考えれば許容の範囲だろう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>list</span>)</span>calc-bmis</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> calc-bmis<span class="paren2">(<span class="code">xs</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code">incf-cl:lc <span class="paren4">(<span class="code">bmi w h</span>)</span><span class="paren4">(<span class="code">incf-cl:&lt;- <span class="paren5">(<span class="code">w . h</span>)</span> xs</span>)</span></span>)</span>
    <span class="keyword">:where</span> <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="keyword">:flet</span> bmi<span class="paren5">(<span class="code">weight height</span>)</span></span>)</span><span class="paren4">(<span class="code">infix-math:$ weight / height infix-math:^ 2</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<pre><code><span class="code"><span class="function">describeList</span> <span class="keyword">::</span> <span class="paren1">[<span class="code">a</span>]</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">desribeList</span> ls <span class="keyword">=</span> <span class="string">"The list is "</span> <span class="atom">++</span> what ls
&nbsp;   <span class="keyword">where</span> what <span class="paren1">[<span class="code"></span>]</span> <span class="keyword">=</span> <span class="string">"empty."</span>
&nbsp;         what <span class="paren1">[<span class="code">x</span>]</span> <span class="keyword">=</span> <span class="string">"singleton list."</span>
&nbsp;         what xs <span class="keyword">=</span> <span class="string">"a longer list."</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>string</span>)</span>describe-list</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> describe-list<span class="paren2">(<span class="code">list</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i>
    <span class="paren3">(<span class="code">uiop:strcat <span class="string">"The list is "</span> <span class="paren4">(<span class="code">what list</span>)</span></span>)</span>
    <span class="keyword">:where</span>
    <span class="paren3">(<span class="code"><span class="paren4">(<span class="code"><span class="keyword">:flet</span> what<span class="paren5">(<span class="code">x</span>)</span></span>)</span>
     <span class="paren4">(<span class="code">trivia:match x
       <span class="paren5">(<span class="code">nil <span class="string">"empty."</span></span>)</span>
       <span class="paren5">(<span class="code"><span class="paren6">(<span class="code">list _</span>)</span> <span class="string">"singleton list."</span></span>)</span>
       <span class="paren5">(<span class="code">_ <span class="string">"a longer list."</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<h2>Reader macro.</h2>

<p>リーダマクロを実装するなら以下のような感じか。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> |#{-reader|<span class="paren2">(<span class="code">stream character number</span>)</span>
  <span class="paren2">(<span class="code">declare<span class="paren3">(<span class="code">ignore character number</span>)</span></span>)</span>
  `<span class="paren2">(<span class="code"><i><span class="symbol">with-forward-reference</span></i> ,@<span class="paren3">(<span class="code">read-delimited-list <span class="character">#\}</span> stream t</span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">named-readtables:defreadtable</span></i> <span class="keyword">:where-syntax</span>
  <span class="paren2">(<span class="code"><span class="keyword">:merge</span> <span class="keyword">:standard</span></span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:dispatch-macro-char</span> <span class="character">#\#</span> <span class="character">#\{</span> #'|#{-reader|</span>)</span>
  <span class="paren2">(<span class="code"><span class="keyword">:syntax-from</span> <span class="keyword">:standard</span> <span class="character">#\)</span> <span class="character">#\}</span></span>)</span></span>)</span></span></code></pre>

<p>利用する場合は以下のようになる。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code">named-readtables:in-readtable <span class="keyword">:where-syntax</span></span>)</span>
<span class="paren1">(<span class="code">declaim<span class="paren2">(<span class="code">ftype<span class="paren3">(<span class="code"><i><span class="symbol">function</span></i><span class="paren4">(<span class="code">list</span>)</span>string</span>)</span>describe-list</span>)</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> describe-list<span class="paren2">(<span class="code">list</span>)</span>
  #{<span class="paren2">(<span class="code">uiop:strcat <span class="string">"The list is "</span> <span class="paren3">(<span class="code">what list</span>)</span></span>)</span>
    <span class="keyword">:where</span>
    <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="keyword">:flet</span> what<span class="paren4">(<span class="code">x</span>)</span></span>)</span>
     <span class="paren3">(<span class="code">trivia:match x
       <span class="paren4">(<span class="code">nil <span class="string">"empty."</span></span>)</span>
       <span class="paren4">(<span class="code"><span class="paren5">(<span class="code">list _</span>)</span> <span class="string">"singleton list."</span></span>)</span>
       <span class="paren4">(<span class="code">_ <span class="string">"a longer list."</span></span>)</span></span>)</span></span>)</span>}</span>)</span></span></code></pre>

<h2>definterface, defcase-of</h2>

<p>HaskellコードとCommon Lispコードとで大きな違いがまだある。
Common Lispのコードは、<code>DEFUN</code>ないし<code>TRIVIA:DEFUN-MATCH</code>のスコープの中で各節を筆記しているのに対し、Haskellのコードではスコープの外で各節を筆記しているように筆者には見える。
実際の実装がどうなっているのかについては知らないのだが、とにかくシンタックス上はそのように見える。</p>

<p>たとえば以下のHaskellコードは、</p>

<pre><code><span class="code"><span class="function">lucky</span> <span class="keyword">::</span> <span class="variable">Int</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">lucky</span> 7 <span class="keyword">=</span> <span class="string">"LUCKY NUMBER SEVEN!"</span>
<span class="function">lucky</span> x <span class="keyword">=</span> <span class="string">"Sorry, you're out of luck, pal!"</span></span></code></pre>

<p>筆者には以下のように見える。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">definterface</span></i> lucky <span class="paren2">(<span class="code">Int</span>)</span> String</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code">lucky 7</span>)</span><span class="string">"LUCKY NUMBER SEVEN"</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code">lucky _</span>)</span><span class="string">"Sorry, you're out of luck, pal!"</span></span>)</span></span></code></pre>

<p>各節が別々のスコープを持ったものとして定義されているように見えるのだ。
丁度<code>DEFGENERIC</code>と<code>DEFMETHOD</code>との関係に似ている。</p>

<p>では、これを再現してみよう。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defconstant</span></i> +skip+ '<span class="keyword">#:skip</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defmacro</span></i> <i><span class="symbol">definterface</span></i> <span class="paren2">(<span class="code">name arg* result</span>)</span>
  <span class="paren2">(<span class="code">check-type name symbol</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">let</span></i><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">gensyms<span class="paren5">(<span class="code"><i><span class="symbol">loop</span></i> <span class="keyword">:for</span> x <span class="keyword">:in</span> arg*
                     <span class="keyword">:collect</span> <span class="paren6">(<span class="code">gensym</span>)</span></span>)</span></span>)</span></span>)</span>
    `<span class="paren3">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren4">(<span class="code">DECLAIM<span class="paren5">(<span class="code">FTYPE<span class="paren6">(<span class="code"><i><span class="symbol">FUNCTION</span></i> ,arg* ,result</span>)</span>,name</span>)</span></span>)</span>
            <span class="paren4">(<span class="code"><i><span class="symbol">DEFUN</span></i> ,name ,gensyms
              <span class="paren5">(<span class="code"><i><span class="symbol">LABELS</span></i><span class="paren6">(<span class="code"><span class="paren1">(<span class="code">REC<span class="paren2">(<span class="code">CLAUSES</span>)</span>
                        <span class="paren2">(<span class="code"><i><span class="symbol">IF</span></i><span class="paren3">(<span class="code">ENDP CLAUSES</span>)</span>
                          <span class="paren3">(<span class="code">ERROR <span class="string">"Unmatch clause ~S ~S"</span>',name <span class="paren4">(<span class="code">list ,@gensyms</span>)</span></span>)</span>
                          <span class="paren3">(<span class="code"><i><span class="symbol">LET</span></i><span class="paren4">(<span class="code"><span class="paren5">(<span class="code">RESULT<span class="paren6">(<span class="code">FUNCALL<span class="paren1">(<span class="code">CAR CLAUSES</span>)</span>,@gensyms</span>)</span></span>)</span></span>)</span>
                            <span class="paren4">(<span class="code"><i><span class="symbol">IF</span></i><span class="paren5">(<span class="code">EQ +SKIP+ RESULT</span>)</span>
                              <span class="paren5">(<span class="code">REC<span class="paren6">(<span class="code">CDR CLAUSES</span>)</span></span>)</span>
                              RESULT</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
                <span class="paren6">(<span class="code">REC<span class="paren1">(<span class="code">OR <span class="paren2">(<span class="code">GET ',name 'CLAUSES</span>)</span>
                        <span class="paren2">(<span class="code">ERROR <span class="string">"No pattern match clause in ~S"</span>',name</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defmacro</span></i> <i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code"><span class="paren3">(<span class="code">name&amp;options &amp;rest pattern*</span>)</span> &amp;body body</span>)</span>
  <span class="paren2">(<span class="code">multiple-value-bind<span class="paren3">(<span class="code">name options</span>)</span><span class="paren3">(<span class="code">parse-name&amp;options name&amp;options</span>)</span>
    <span class="paren3">(<span class="code"><i><span class="symbol">let*</span></i><span class="paren4">(<span class="code"><span class="paren5">(<span class="code">lambda-list<span class="paren6">(<span class="code">millet:lambda-list name</span>)</span></span>)</span>
          <span class="paren5">(<span class="code"><i><span class="symbol">defalut-clause</span></i><span class="paren6">(<span class="code"><i><span class="symbol">loop</span></i> <span class="keyword">:repeat</span> <span class="paren1">(<span class="code">length lambda-list</span>)</span>
                               <span class="keyword">:collect</span> '_</span>)</span></span>)</span>
          <span class="paren5">(<span class="code">body`<span class="paren6">(<span class="code">TRIVIA:MATCH*,lambda-list
                  <span class="paren1">(<span class="code">,pattern* ,@body</span>)</span>
                  <span class="paren1">(<span class="code">,<i><span class="symbol">defalut-clause</span></i> +SKIP+</span>)</span></span>)</span></span>)</span></span>)</span>
      `<span class="paren4">(<span class="code">ALEXANDRIA:APPENDF<span class="paren5">(<span class="code">GET ',name 'CLAUSES</span>)</span>
         <span class="paren5">(<span class="code">LIST <span class="paren6">(<span class="code"><i><span class="symbol">LAMBDA</span></i>,lambda-list
                 ,<span class="paren1">(<span class="code"><i><span class="symbol">if</span></i> options
                    `<span class="paren2">(<span class="code">TRIVIA:LET-MATCH1<span class="paren3">(<span class="code">LIST ,@options</span>)</span><span class="paren3">(<span class="code">LIST ,@lambda-list</span>)</span>
                       ,body</span>)</span>
                    body</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> parse-name&amp;options<span class="paren2">(<span class="code">n&amp;o</span>)</span>
  <span class="paren2">(<span class="code"><i><span class="symbol">if</span></i><span class="paren3">(<span class="code">symbolp n&amp;o</span>)</span>
    <span class="paren3">(<span class="code">values n&amp;o nil</span>)</span>
    <span class="paren3">(<span class="code">values <span class="paren4">(<span class="code">car n&amp;o</span>)</span><span class="paren4">(<span class="code">cdr n&amp;o</span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>これで以下のように書ける。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">definterface</span></i> lucky <span class="paren2">(<span class="code">fixnum</span>)</span> string</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code">lucky 7</span>)</span><span class="string">"LUCKY NUMBER SEVEN"</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code">lucky _</span>)</span><span class="string">"Sorry, you're out of luck, pal!"</span></span>)</span></span></code></pre>

<p>as-patternにも対応している。</p>

<pre><code><span class="code"><span class="function">firstLetter</span> <span class="keyword">::</span> <span class="variable">String</span> <span class="keyword">-&gt;</span> <span class="variable">String</span>
<span class="function">firstLetter</span> <span class="string">""</span> <span class="keyword">=</span> <span class="string">"Empty string, whoops!"</span>
<span class="function">firstLetter</span> all<span class="keyword">@</span><span class="paren1">(<span class="code">x<span class="variable">:</span>xs</span>)</span> <span class="keyword">=</span> <span class="string">"The first letter of "</span> <span class="atom">++</span> all <span class="atom">++</span> <span class="string">"is "</span> <span class="atom">++</span> <span class="paren1">[<span class="code">x</span>]</span></span></code></pre>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">definterface</span></i> first-letter <span class="paren2">(<span class="code">string</span>)</span>string</span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code">first-letter <span class="string">""</span></span>)</span><span class="string">"Empty string, whoops!"</span></span>)</span>
<span class="paren1">(<span class="code"><i><span class="symbol">defcase-of</span></i><span class="paren2">(<span class="code"><span class="paren3">(<span class="code">first-letter all</span>)</span><span class="paren3">(<span class="code">trivia:string* x _</span>)</span></span>)</span>
  <span class="paren2">(<span class="code">uiop:strcat <span class="string">"The first letter of "</span> all <span class="string">" is "</span> x</span>)</span></span>)</span></span></code></pre>

<footer>
  <a href='../index.html'>Index
  </a>
</footer>
</body>
</html>